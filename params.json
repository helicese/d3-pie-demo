{"name":"D3-pie-demo","tagline":"a data visualization of some data from the library, using the pie layout of the d3 library including some tips of using the pie layout","body":"##Description:\r\n这是一个D3实线饼状图的demo,效果图如下,数据是一个人在图书馆的借书数据,内圈把所有借过的书进行统计,表示的是不同类别的书所占比例的大小,外圈表示按时间顺序排列下来的借书记录,按月分,灰色部分表示没有借书的时间段,其他颜色表示各个类别的书\r\n##Presentation:\r\n默认视图,会有扇子展开的动态效果:\r\n![default](http://7xiieb.com1.z0.glb.clouddn.com/default.png)\r\n鼠标悬停特效,显示某一类别书在时间轴上的分布:\r\n![default](http://7xiieb.com1.z0.glb.clouddn.com/hover.png)\r\n点击事件:内圈点击出现类别和书的数目,外圈点击相应条段会显示书籍信息以及借阅时间,\r\n![default](http://7xiieb.com1.z0.glb.clouddn.com/click.png)\r\n##Data:\r\n原始数据:lxy.csv\r\n处理文件:preprocess.py(别人写的,我做了修改)\r\n结果文件:nodes2.js\r\n```\r\n{name:\"大学物理学习题详解\", catagory:\"O\", interval:\"86\", borrow_date:\"20120906\", return_date:\"20121201\"},\r\n{name:\"固体物理学基础\", catagory:\"O\", interval:\"73\", borrow_date:\"20141018\", return_date:\"20141230\"},\r\n{name:\"2010考研数学核心题型， 理工类·数学二\", catagory:\"O\", interval:\"68\", borrow_date:\"20140503\", return_date:\"20140710\"},\r\n{name:\"考研数学单选题解题方法与技巧\", catagory:\"O\", interval:\"68\", borrow_date:\"20140503\", return_date:\"20140710\"},\r\n{name:\"应用流体力学\", catagory:\"O\", interval:\"64\", borrow_date:\"20130825\", return_date:\"20131028\"},\r\n```\r\n##实现算法:\r\n外圈的实现还是让我脑疼了一段时间;\r\n\r\n* 需求: 按月分,按时间排序,时间的起止时间为数据文件里的最早时间和最晚时间,每个月内不同的颜色表示不同类别的书,该类别书数目越多则色条越宽.\r\n* 初始想法: 由于色条宽度和类别有关,要统计每类在每月的分布,然后每个月本身可能还会有空余,得把留空体现出来,感觉得先画一个圈表示所用的空余时间,然后再用借书的圈来覆盖,觉得这种双层的效果并不好实现,\r\n* 最终想法: 先把数据按照借阅时间排序,然后给每本书定一个大小为一的衡量角度的值,把每本书按照借阅时间在圆环上排序,此时每本书都等宽,然后就来分月份,每个月的剩余天数用20减去前面统计的本月所借书的数目,把剩余天数插入每个月最后借的那本书后面,最终实现按月排布的效果,并且避免了可能的双层的麻烦\r\n* **具体实现:**\r\n* 首先用冒泡排序把书目按照借阅时间的顺序排个序;\r\n```\r\n    for(var i = data.length - 1; i >= 0; i--){\r\n\t\tfor (var j = 0; j < i; j++) {\r\n\t\t\tvar temp1 = timeformat.parse(data[i][\"borrow_date\"]);\r\n\t\t\tvar temp2 = timeformat.parse(data[j][\"borrow_date\"]);\r\n\t\t\tif (temp1 < temp2) {\r\n\t\t\t\tvar temp = data[i];\r\n\t\t\t\tdata[i] = data[j];\r\n\t\t\t\tdata[j] = temp;\r\n\t\t\t};\t\t\t\r\n\t\t};\r\n\t};\r\n```\r\n\r\n* 然后就是如何去插入月份空余,注释很清楚啦!\r\n```\r\n\t//用于计算本月空余时间\r\n\tvar countMonth = 0;\r\n\tvar dataLength = data.length;\r\n\tfor(i = 0; i < dataLength; i++){\r\n\t\t//给每条数据定义一个衡量角度的值num = 1,\r\n\t\tif(!data[i].num){\r\n\t\t\tdata[i].num = 1;\r\n\t\t\tdata[i].yearMonth = monthformat(timeformat.parse(data[i][\"borrow_date\"]));\r\n\t\t};\r\n\t\t//判断这条数据是不是刚刚添加的该月空余\r\n\t\tif(data[i][\"borrow_date\"]){\r\n\t\t\tvar tempMonth1 = timeformat.parse(data[i][\"borrow_date\"]).getMonth();\r\n\t\t\t//判断是否是最后一条数据,保证数据有效\r\n\t\t\tif(data[parseInt(i)+1]){\r\n\t\t\t\tvar tempMonth2 = timeformat.parse(data[parseInt(i)+1][\"borrow_date\"]).getMonth();\t\t\r\n\t\t\t}\r\n\t\t\t//最后一条数据的话就直接在后面添加该月的空余\r\n\t\t\telse{\r\n\t\t\t\tdata.push({\"num\": 20-countMonth,\"catagory\": \"Q\",\"name\":\"没借书的时间段\",\"yearMonth\": data[i].yearMonth});\r\n\t\t\t\t//结束循环\r\n\t\t\t\tbreak;\r\n\t\t\t};\r\n\t\t}\r\n\t\t//若是空余时间就直接跳过\r\n\t\telse{\r\n\t\t\tcontinue;\r\n\t\t};\r\n\t\t//判断前后记录是不是同一个月,用来判断是否该添加本月空余\r\n\t\tif(tempMonth1 == tempMonth2)\r\n\t\t{\r\n\t\t\t//用来计算最终的空余时间\r\n\t\t\tcountMonth = countMonth + 1;\r\n\t\t}\r\n\t\telse{\r\n\t\t\t//添加本月空余,20是我自定义的数\r\n\t\t\tdata.splice(parseInt(i)+1, 0, {\"num\": 20-countMonth,\"catagory\": \"Q\",\"name\":\"没借书的时间段\",\"yearMonth\":data[i].yearMonth});\r\n\t\t\t//数据条数增加\r\n\t\t\tdataLength++;\r\n\t\t\t//借阅数目归0\r\n\t\t\tcountMonth = 0;\r\n\t\t};\r\n\t};\r\n```\r\n##饼图的123\r\n* 饼图绘制 = 数据转换(d3.layout.pie,将普通数据转换成适合饼图绘制的数据) + 绘制图形(添加\"path\")\r\n* 数据转换后的格式:\r\nvalue是决定该块区域所跨越的角度的衡量值\r\ndata为用户传递的数据\r\n```\r\ndata: Object\r\n    borrow_date: \"20111224\"\r\n    catagory: \"H\"\r\n    interval: \"62\"\r\n    name: \"基础德语\"\r\n    num: 1\r\n    return_date: \"20120224\"\r\n    yearMonth: \"2011-12\"\r\n    __proto__: Object\r\nendAngle: 0.7428396422281287\r\npadAngle: 0\r\nstartAngle: 0.7325224249749602\r\nvalue: 1\r\n```\r\n* d3.layout.pie()默认只接受一个数组,要想传递其他信息,则得设置其访问器的value值,如下:d是传入的数据,格式随意,但d.population得构成一个数组!\r\n```\r\nvar pie = d3.layout.pie()\r\n    .value(function(d){ return d.population; });\r\n```\r\n* d3的饼图会默认将内容按照大小按从大到小的顺序来排列,在我这个项目里我要自定义顺序时,得禁用这自动排序.用sort(null):[问题链接](http://stackoverflow.com/questions/17169504/pie-donut-chart-segment-order-in-d3)\r\n```\r\nvar outerRing = d3.layout.pie()\r\n\t\t\t\t\t.value(function(d)\r\n\t\t\t\t\t\t{\r\n\t\t\t\t\t\t\treturn d.num;\r\n\t\t\t\t\t\t})\r\n\t\t\t\t\t.startAngle(0)\r\n\t\t\t\t\t.sort(null);\r\n```\r\n\r\n\r\n##关于d3.js\r\n* 参考链接:\r\n    * [数据可视化专题站](http://www.ourd3js.com/wordpress/):我所见的最好的中文教程\r\n    * [饼图参考](http://www.ourd3js.com/wordpress/?p=190):解决了我许多问题\r\n    * [饼图参考2](http://bl.ocks.org/kerryrodden/7090426)\r\n\r\n---\r\n\r\n- 李辉   \r\n- helicese@gmail.com\r\n- 热爱学习的前端小兵,欢迎前来交流讨论\r\n- 2015.6.11\r\n\r\n\r\n\r\n","google":"","note":"Don't delete this file! It's used internally to help with page regeneration."}